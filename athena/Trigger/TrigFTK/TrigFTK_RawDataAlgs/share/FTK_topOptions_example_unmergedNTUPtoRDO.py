# Set the job properties:

ftktag="TDAQTDRv2"
FTK_MergeFromTowers=True

outputNTUP_FTKFile="NTUP_FTK.root"
outputRDOfile="FTKRDO.pool.root"

inputNTUP_FTKTMPFile=["ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_1.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_2.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_3.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_4.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_5.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_6.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_7.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_8.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_9.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_10.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_11.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_12.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_13.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_14.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_15.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_16.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_17.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_18.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_19.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_20.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_21.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_22.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_23.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_24.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_25.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_26.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_27.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_28.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_29.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_30.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_31.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_32.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_33.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_34.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_35.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_36.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_37.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_38.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_39.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_40.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_41.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_42.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_43.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_44.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_45.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_46.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_47.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_48.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_49.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_50.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_51.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_52.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_53.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_54.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_55.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_56.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_57.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_58.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_59.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_60.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_61.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_62.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_63.root","ftksimoutput_Validation_devval_ttbarPU20_Comm_unsplit_20140506/NTUP_FTKTMP_64.root"]


#----------------------------------------------------------------------

from AthenaCommon.Logging import logging
ftkLog = logging.getLogger('FTKStandaloneMergeToRDO')
#ftkLog.propagate = False
ftkLog.info( '********** STARTING FTKStandaloneMergeToRDO **********' )


from AthenaCommon.AthenaCommonFlags import jobproperties as jp

from PerfMonComps.PerfMonFlags import jobproperties as pmjp;
pmjp.PerfMonFlags.doSemiDetailedMonitoring = True

from RecExConfig.RecFlags import rec
rec.doWriteRDO.set_Value_and_Lock(True)
#rec.OutputLevel.set_Value_and_Lock(DEBUG)

theApp.EvtMax = 4
#theApp.EvtMax = -1 

from AthenaCommon.AlgSequence import AlgSequence
alg = AlgSequence()

# Helper function from transforms 
from PyJobTransforms.trfUtils import findFile

# this dictionary describe the standard position for common files, this allow
# a shorter command line when standard files are used
ftkBaseConfigDir = findFile(os.environ['DATAPATH'], 'ftk_configuration')
if ftkBaseConfigDir is None:
    ftkLog.warning('Failed to find ftk_configuration directory searching along $DATAPATH - all paths must now be given explicitly')
    standardConfBaseDir = {}
else:
    ftkLog.info('Found ftk_configuration directory {0}'.format(ftkBaseConfigDir))
    standardConfBaseDir = {'loadHWConf_path': os.path.join(ftkBaseConfigDir, 'hwsdev_file'),
                           'pmap_path': os.path.join(ftkBaseConfigDir, 'map_files')
                           }

# --------------------------------------------------------------
# FTK algorithm inclusions
# --------------------------------------------------------------
from AthenaCommon.AppMgr import ToolSvc 
from TrigFTK_RawDataAlgs.TrigFTK_RawDataAlgsConf import FTK_RDO_CreatorAlgo
import os
import sys

FTK_RDO_Creator = FTK_RDO_CreatorAlgo( "FTK_RDO_CreatorAlgo")
FTK_RDO_Creator.OutputLevel = VERBOSE
FTK_RDO_Creator.doMerging = True # this enables the behavior of the FTK_RDO_CreatorAlgo as FTK streams merger

runArgsMandatory =  ['NBanks', 'NSubRegions', 'pmap_path', 'loadHWConf_path']

runArgsOptional = {'FirstRegion': 0, 'FirstSubreg': 0, 'MergeRegion': -1, 'HWNDiff': 6, 'HitWarrior': 2}

# prestore some common configurations that can be called through the option FTKSetupTag

FTK_RDO_Creator.NBanks=64

if ftktag=="TDRv0" or ftktag=="TDRv1":
    FTK_RDO_Creator.pmap_path=ftkBaseConfigDir+'map+files/raw_11L.pmap'
    FTK_RDO_Creator.loadHWConf_path=ftkBaseConfigDir+'/hwsdev_file/raw_11L.hw'

if ftktag=="TDAQTDRv0" or ftktag=="TDAQTDRv1" or ftktag=="TDAQTDRv2":
    FTK_RDO_Creator.pmap_path=ftkBaseConfigDir+'/map_files/raw_12Libl.pmap'
    FTK_RDO_Creator.loadHWConf_path=ftkBaseConfigDir+'/hwsdev_file/raw_12L.hw'
        

# The presence of the option FinalMerge
if FTK_MergeFromTowers:
    FTK_RDO_Creator.NSubRegions = 1
    FTK_RDO_Creator.FTKUnmergedFormatName = "FTKMergedTracksStream%u"
else:
    FTK_RDO_Creator.NSubRegions=4


# set a meaningful name for the PerfMon file
pmjp.PerfMonFlags.OutputFile = 'ntuple_FTKMerge.pmon.gz'

FTK_RDO_Creator.FTKToMergePaths = inputNTUP_FTKTMPFile
FTK_RDO_Creator.FTKMergedOutput = outputNTUP_FTKFile

alg += FTK_RDO_Creator  

#StreamRDO            = AthenaPoolOutputStream ( "StreamRDO" )
#StreamRDO.OutputFile = "InDetRecRDO.root"
#StreamRDO.ItemList   +=  ['FTK_RawTrackContainer#*']

from OutputStreamAthenaPool.MultipleStreamManager import MSMgr
 
StreamRDO=MSMgr.NewPoolStream("StreamRDO", outputRDOfile)
StreamRDO.AddMetaDataItem(["IOVMetaDataContainer#*"])
#StreamRDO.AddItem( ["DataVector<FTK_RawTrack>#FTK_RDO_Tracks"] )
StreamRDO.AddItem( ["FTK_RawTrackContainer#*"] ) 
from RecExConfig.ObjKeyStore import objKeyStore
objKeyStore.addStreamRDO("FTK_RawTrackContainer","FTK_RDO_Tracks")
